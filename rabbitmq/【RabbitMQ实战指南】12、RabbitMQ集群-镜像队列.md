### RabbitMQ集群-镜像队列

---

#### 1、镜像队列

- RabbitMQ在2.6.0版本之后，Rabbit团队给我们带来了内建的双活冗余选项：镜像队列
- 镜像队列的主拷贝仅存在于一个节点（主队列，master节点）上
- 镜像节点在集群中的其他节点上拥有从队列（slave）的拷贝
- 主节点不可用，最老的从队列将被选举为新的主队列

#### 2、声明镜像队列的方法

- 声明队列增加参数{"x-ha-policy": "all"}

- 镜像队列声明之后，在集群中增加了新的节点，那么该节点就会自动托管一份队列的从拷贝

- 如果不想让队列在集群中的所有节点上都拥有镜像，可以在声明队列时指定的参数设置为

  {"x-ha-policy":"nodes", "x-ha-policy-params": ["rabbit@someone"]}

#### 3、镜像队列的工作原理

![image-20200727203400501](https://i.loli.net/2020/07/27/l4Gru8x9UtCT3IA.png)

- 当加入镜像队列后，信道仍然做着同样的事情。除了将消息按照路由绑定规则投递到合适的队列之外，它也要将消息投递到镜像队列的从拷贝。在某种程度上，你可以将镜像队列视为拥有一个隐藏的fanout交换器，它指示着信道将消息分发到队列的从拷贝上。
- 如果客户端库不能支持消费者取消通知的话，应该避免使用镜像队列。不然的话，你的队列会被未消费的消息塞满，然后监控系统就会在半夜用电话叫醒你。