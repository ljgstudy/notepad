### 消费端的确认和拒绝

---

#### 1、消息确认机制ACK

- autoAck设置为false时，RabbitMQ会等待消费者显示地回复确认信号后才从内存或者磁盘中移除消息，实际上时先打上标记，之后再删除。这样消费者会有足够的时间处理消息，不用担心处理消息的过程中消费者进程挂掉后消息丢失的问题
- autoAck设置为false，对于RabbitMQ而言，队列中的消息分为两部分，一部分是等待投递给消费者的消息；一部分是已经投递给消费者，但是还是没有收到消费者确认信号的消息。如果RabbitMQ一直没有收到消费者的确认信号，并且消费此消息的消费者已经断开连接，则RabbitMQ会安排该消息重新进入队列，等待投递给下一个消费者，当然也有可能还是原来的消费者
- autoAck不会为未确认的消息设置过期时间，这样允许消费者消费一条消息的时间可以很久很久
- autoAck设置为true，RabbitMQ会自动把发出去的消息置为确认，然后从内存或者磁盘中删除，而不管消费者是否真正的消费了到达的这些消息

#### 2、拒绝消息

- RabbitMQ在2.0.0版本开始引入了Basic.Reject命令来明确拒绝一条消息
- 设置了requeue参数为true，RabbitMQ会重新将这条消息存入队列，以便可以发送给下一个订阅的消费者
- 设置了requeue参数为false, RabbitMQ立即会把消息从队列中移除，而不会把它发送给新的消费者
- Basic.Nack可以批量拒绝消息
- 将channel.basicReject或者channel.basicNack中的requeue设置为false，可以启用死信队列的功能，死信队列可以通过检测被拒绝或者未送达的消息来追踪问题
- Basic.Recover具备可重入对列的特性，用来请求RabbitMQ重新发送未被确认的消息。如果requeue参数设置为true，则未被确认的消息会被重新加入到对列中，这样对于同一条消息来说，可能会被分配给与之前不同的消费者。如果requeue参数设置为false，那么同一条消息会被分配给与之前相同的消费者。默认情况下，如果不设置requeue这个参数，相当于channel.basicRecover(true),即requeue默认为true